{% extends 'base.html' %}
{% block content %}

<!-- Results Section -->
<section class="results-section section" style="padding-top: 6rem;">
    <div class="container">
        <!-- Header -->
        <div class="results-header animate-fade-up" style="margin-bottom: 2rem;">
            <div>
                <h1 style="font-size: 1.75rem; color: #e2e8f0;" class="mb-1">Analysis <span
                        class="gradient-text">Results</span></h1>
                <p class="mb-0" style="color: #cbd5e1;">
                    <i class="bi bi-hash me-1"></i>Case ID: <code
                        style="background: var(--bg-glass); padding: 0.25rem 0.5rem; border-radius: 4px; color: #00FFFF;">{{ case_id }}</code>
                </p>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <a class="btn btn-secondary" href="{{ url_for('download_report', case_id=case_id) }}">
                    <i class="bi bi-download"></i> Download Report
                </a>
                <a class="btn btn-primary" href="{{ url_for('check_model') }}">
                    <i class="bi bi-plus-circle"></i> New Analysis
                </a>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav tabs animate-fade-up delay-1" id="caseTabs" role="tablist" style="margin-bottom: 1.5rem;">
            <li><button class="tab active" data-bs-toggle="tab" data-bs-target="#img" type="button"><i
                        class="bi bi-image me-1"></i> Image</button></li>
            <li><button class="tab" data-bs-toggle="tab" data-bs-target="#heat" type="button"><i
                        class="bi bi-fire me-1"></i> Heatmaps</button></li>
            <li><button class="tab" data-bs-toggle="tab" data-bs-target="#report" type="button"><i
                        class="bi bi-file-text me-1"></i> Report</button></li>
            <li><button class="tab" data-bs-toggle="tab" data-bs-target="#chatp" type="button"><i
                        class="bi bi-chat-dots me-1"></i> Chat</button></li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content results-panel animate-fade-up delay-2">
            <!-- Image Tab -->
            <div class="tab-pane fade show active" id="img" role="tabpanel">
                <div class="row g-4">
                    <div class="col-lg-6">
                        <h4 class="mb-3" style="color: #e2e8f0;"><i class="bi bi-image gradient-text me-2"></i>Processed
                            X-ray</h4>
                        {% if processed_image %}
                        <div class="glass-card-sm p-3">
                            <img class="img-fluid"
                                src="{{ url_for('case_file', case_id=case_id, filename=processed_image) }}" alt="X-ray"
                                style="border-radius: var(--radius-sm); max-width: 100%; max-height: 500px; width: auto; display: block; margin: 0 auto;">
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-image"></i>
                            <p style="color: #cbd5e1;">No processed image found.</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="col-lg-6">
                        <h4 class="mb-3" style="color: #e2e8f0;"><i class="bi bi-activity gradient-text me-2"></i>AI
                            Predictions</h4>
                        {% if predictions %}
                        <div>
                            {% for p in predictions %}
                            <div class="prediction-item">
                                <span class="prediction-label">{{ p.label }}</span>
                                <span class="prediction-score">{{ p.confidence }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="glass-card-sm text-center" style="padding: 3rem;">
                            <i class="bi bi-check-circle" style="font-size: 3rem; color: var(--emerald);"></i>
                            <p class="mt-2 mb-1" style="font-weight: 600; color: #e2e8f0;">No Pathologies Detected</p>
                            <p class="text-sm mb-0" style="color: #cbd5e1;">X-ray appears normal or findings are below
                                confidence
                                threshold.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Heatmaps Tab -->
            <div class="tab-pane fade" id="heat" role="tabpanel">
                <h4 class="mb-2" style="color: #e2e8f0;"><i class="bi bi-fire gradient-text me-2"></i>Grad-CAM Heatmaps
                </h4>
                <p class="mb-3" style="color: #cbd5e1;">Visualizations showing which regions influenced each prediction.
                    <strong style="color: var(--rose);">Red/Yellow</strong> = high attention, <strong
                        style="color: var(--cyan);">Blue/Green</strong> = low attention.
                </p>

                {% if heatmaps %}
                <div class="row g-3">
                    {% for h in heatmaps %}
                    <div class="col-md-6">
                        <div class="glass-card-sm p-3">
                            <img src="{{ url_for('case_file', case_id=case_id, filename=h) }}" alt="{{ h }}"
                                style="width: 100%; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span style="color: #e2e8f0; font-weight: 600;">
                                    <i class="bi bi-layers me-1"></i>{{ h.replace('heatmap_','').replace('.png','') }}
                                </span>
                                <a href="{{ url_for('case_file', case_id=case_id, filename=h) }}" download="{{ h }}"
                                    class="btn btn-secondary btn-sm">
                                    <i class="bi bi-download"></i> Download
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-fire"></i>
                    <p style="color: #cbd5e1;">No heatmaps generated.</p>
                    <p class="text-sm" style="color: #94a3b8;">Heatmaps are created for pathologies detected with
                        confidence above
                        50%.</p>
                </div>
                {% endif %}
            </div>

            <!-- Report Tab -->
            <div class="tab-pane fade" id="report" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h4 class="mb-0" style="color: #e2e8f0;"><i
                            class="bi bi-file-earmark-medical gradient-text me-2"></i>Diagnostic Report</h4>
                    <a class="btn btn-secondary" href="{{ url_for('download_report', case_id=case_id) }}">
                        <i class="bi bi-download me-1"></i> Download .txt
                    </a>
                </div>
                <div class="report-box">{{ report_text }}</div>
                <p class="text-sm mt-3 mb-0" style="color: #cbd5e1;">
                    <i class="bi bi-exclamation-triangle me-1" style="color: var(--amber);"></i>
                    This AI-generated report is for informational purposes only. Always consult a qualified physician
                    for diagnosis.
                </p>
            </div>

            <!-- Chat Tab -->
            <div class="tab-pane fade" id="chatp" role="tabpanel">
                <h4 class="mb-2" style="color: #e2e8f0;"><i class="bi bi-chat-dots gradient-text me-2"></i>Ask About
                    Your Results</h4>
                <p class="mb-3" style="color: #cbd5e1;">Ask questions about findings, confidence scores, or explanations
                    in the report.</p>

                <div id="chat-log" class="chat-container"></div>

                <form id="chat-form" class="chat-form">
                    <input id="chat-input" class="chat-input" type="text"
                        placeholder="E.g., What pathologies were found?" autocomplete="off" required>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i>
                    </button>
                </form>

                <p class="text-sm mt-3 mb-0" style="color: #cbd5e1;">
                    <i class="bi bi-info-circle me-1"></i>
                    The AI answers based strictly on the report content. For medical advice, consult a physician.
                </p>
            </div>
        </div>
    </div>
</section>

<script>
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatLog = document.getElementById('chat-log');

    function addMsg(role, text) {
        const div = document.createElement('div');
        div.className = 'chat-message ' + role;
        div.textContent = text;
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    if (chatForm) {
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const q = chatInput.value.trim();
            if (!q) return;

            // 1. Show user message
            addMsg('user', q);
            chatInput.value = '';

            // 2. Show "Thinking..." indicator
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'chat-message assistant';
            thinkingDiv.innerHTML = '<i class="bi bi-robot"></i> Thinking...';
            chatLog.appendChild(thinkingDiv);
            chatLog.scrollTop = chatLog.scrollHeight;

            try {
                const res = await fetch("{{ url_for('chat', case_id=case_id) }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: q })
                });
                const data = await res.json();

                // 3. Replace "Thinking..." with actual answer
                thinkingDiv.innerHTML = data.answer || 'No response received.';
            } catch (err) {
                thinkingDiv.innerHTML = 'Error reaching the AI server. Please try again.';
            }
        });
    }
</script>

{% endblock %}